// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  AGENT
  CUSTOMER
}

enum TicketStatus {
  NEW
  OPEN
  IN_PROGRESS
  PENDING
  RESOLVED
  CLOSED
  INITIATE_REFUND
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationType {
  TICKET_ASSIGNED
  TICKET_UPDATED
  TICKET_REPLY
  TICKET_STATUS_CHANGED
  TICKET_MENTION
  PRIORITY_ESCALATION
  SLA_BREACH
  FACEBOOK_POST
  FACEBOOK_COMMENT
  FACEBOOK_MESSAGE
}

enum FacebookNotificationType {
  POST
  COMMENT
  MESSAGE
}

model Tenant {
  id          String   @id @default(cuid())
  name        String   // Company name
  slug        String   @unique // URL-friendly identifier (e.g., "company-a")
  domain      String?  @unique // Custom domain (optional)
  isActive    Boolean  @default(true)
  settings    Json?    // Tenant-specific settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  tickets     Ticket[]
  categories  Category[]
  teams       Team[]
  tags        Tag[]
  templates   Template[]
  autoAssignmentRules AutoAssignmentRule[]
  facebookIntegrations FacebookIntegration[]
  systemSettings SystemSettings[]
  orderTrackingData OrderTrackingData[]

  @@index([slug])
  @@index([domain])
  @@index([isActive])
}

model User {
  id        String   @id @default(cuid())
  tenantId  String   // Multi-tenant: Company/Organization ID
  email     String
  name      String?
  password  String?
  role      UserRole @default(CUSTOMER)
  avatar    String?
  phone     String?
  company   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant                  Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tickets                 Ticket[]
  assignedTickets         Ticket[]                 @relation("AssignedTickets")
  comments                Comment[]
  notifications           Notification[]           @relation("NotificationReceiver")
  notificationsActed      Notification[]           @relation("NotificationActor")
  auditLogs               AuditLog[]
  satisfactionRatings     SatisfactionRating[]
  categories              Category[]               @relation("AgentCategories")
  notificationPreferences NotificationPreference[]
  pushSubscriptions       PushSubscription[]
  teamMembers             TeamMember[]
  ticketActivities        TicketActivity[]
  callLogs                CallLog[]           @relation("CallLogs")
  penalizedTickets        Ticket[]            @relation("PenalizedTickets")

  @@unique([tenantId, email]) // Email unique per tenant
  @@index([email])
  @@index([role])
  @@index([tenantId])
  @@index([tenantId, email])
  @@index([tenantId, role])
}

model Category {
  id          String   @id @default(cuid())
  tenantId    String   // Multi-tenant: Company/Organization ID
  name        String
  description String?
  parentId    String?
  color       String?
  icon        String?
  subjects    Json?    // Array of subject strings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent    Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  tickets   Ticket[]
  agents    User[]    @relation("AgentCategories")

  @@index([parentId])
  @@index([tenantId])
  @@index([tenantId, parentId])
}

enum TicketSource {
  EMAIL
  FACEBOOK_POST
  FACEBOOK_COMMENT
  FACEBOOK_MESSAGE
  MANUAL
  API
}

model Team {
  id          String   @id @default(cuid())
  tenantId    String   // Multi-tenant: Company/Organization ID
  name        String
  description String?
  color       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant    Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tickets   Ticket[]
  members   TeamMember[]
  slaRules  SLARule[]

  @@unique([tenantId, name]) // Team name unique per tenant
  @@index([isActive])
  @@index([tenantId])
  @@index([tenantId, isActive])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("MEMBER") // MEMBER, LEAD
  createdAt DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model SLARule {
  id             String         @id @default(cuid())
  teamId         String?
  priority       TicketPriority
  responseTime   Int // Minutes
  resolutionTime Int // Minutes
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  team Team? @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, priority])
  @@index([priority])
}

model AutoAssignmentRule {
  id          String   @id @default(cuid())
  tenantId    String   // Multi-tenant: Company/Organization ID
  name        String
  description String?
  conditions  Json // Conditions to match (keywords, customer history, etc.)
  actions     Json // Actions (assign to team, agent, set priority, etc.)
  priority    Int      @default(0) // Higher priority rules run first
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([isActive, priority])
  @@index([tenantId])
  @@index([tenantId, isActive, priority])
}

model Ticket {
  id                     String         @id @default(cuid())
  tenantId               String         // Multi-tenant: Company/Organization ID
  ticketNumber           String
  subject                String
  description            String         @db.Text
  status                 TicketStatus   @default(NEW)
  priority               TicketPriority @default(NORMAL)
  categoryId             String?
  customerId             String
  assignedAgentId        String?
  assignedTeamId         String?
  source                 TicketSource   @default(MANUAL)
  facebookPostUrl        String? // Original Facebook post/comment URL
  customerFacebookLink   String? // Customer's Facebook profile link
  dueDate                DateTime?
  resolvedAt             DateTime?
  firstResponseAt        DateTime? // Time of first agent response
  isPenalized            Boolean        @default(false) // Whether ticket is marked as penalized
  penalizedAt            DateTime? // When ticket was marked as penalized
  penalizedBy            String? // User ID who marked as penalized
  refundAmount           Decimal? @db.Decimal(10, 2) // Refund amount for penalized tickets
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  originalEmailMessageId String? // Store Message-ID from ticket creation email for threading

  // Relations
  tenant                 Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer               User                   @relation(fields: [customerId], references: [id])
  assignedAgent          User?                  @relation("AssignedTickets", fields: [assignedAgentId], references: [id])
  category               Category?              @relation(fields: [categoryId], references: [id])
  assignedTeam           Team?                  @relation(fields: [assignedTeamId], references: [id])
  comments               Comment[]
  attachments            Attachment[]
  tags                   TicketTag[]
  notifications          Notification[]
  satisfactionRating     SatisfactionRating?
  callLogs              CallLog[]
  penalizedByUser        User?            @relation("PenalizedTickets", fields: [penalizedBy], references: [id], onDelete: SetNull)
  auditLogs              AuditLog[]
  activities             TicketActivity[]
  FacebookNotification   FacebookNotification[]

  @@unique([tenantId, ticketNumber]) // Ticket number unique per tenant
  @@index([customerId])
  @@index([assignedAgentId])
  @@index([assignedTeamId])
  @@index([status])
  @@index([priority])
  @@index([categoryId])
  @@index([source])
  @@index([createdAt])
  @@index([dueDate])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, customerId])
  @@index([tenantId, assignedAgentId])
}

model Comment {
  id         String   @id @default(cuid())
  content    String   @db.Text
  isInternal Boolean  @default(false)
  ticketId   String
  authorId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  ticket      Ticket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author      User         @relation(fields: [authorId], references: [id])
  attachments Attachment[]

  @@index([ticketId])
  @@index([authorId])
}

model Attachment {
  id        String   @id @default(cuid())
  filename  String
  fileUrl   String
  fileSize  Int
  mimeType  String
  ticketId  String?
  commentId String?
  createdAt DateTime @default(now())

  // Relations
  ticket  Ticket?  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([commentId])
}

model Tag {
  id        String   @id @default(cuid())
  tenantId  String   // Multi-tenant: Company/Organization ID
  name      String
  color     String?
  createdAt DateTime @default(now())

  // Relations
  tenant  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tickets TicketTag[]

  @@unique([tenantId, name]) // Tag name unique per tenant
  @@index([tenantId])
}

model TicketTag {
  id        String   @id @default(cuid())
  ticketId  String
  tagId     String
  createdAt DateTime @default(now())

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([ticketId, tagId])
  @@index([ticketId])
  @@index([tagId])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String           @db.Text
  userId    String
  ticketId  String?
  actorId   String? // Who triggered the notification
  read      Boolean          @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  user                 User                      @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)
  ticket               Ticket?                   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  actor                User?                     @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)
  facebookNotification FacebookNotification?
  deliveryLogs         NotificationDeliveryLog[]

  @@index([userId, read, createdAt])
  @@index([ticketId])
  @@index([createdAt])
}

model FacebookIntegration {
  id                  String   @id @default(cuid())
  tenantId            String   // Multi-tenant: Company/Organization ID
  pageId              String
  pageName            String
  accessToken         String   @db.Text
  webhookToken        String
  isActive            Boolean  @default(true)
  notificationSettings Json?   // { posts: boolean, comments: boolean, messages: boolean, mentions: boolean }
  autoCreateSettings  Json?    // { fromMessages: boolean, fromComments: boolean, keywords: string }
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, pageId]) // Page ID unique per tenant
  @@index([tenantId])
  @@index([tenantId, isActive])
}

model FacebookNotification {
  id                String                   @id @default(cuid())
  type              FacebookNotificationType
  facebookId        String
  facebookPostId    String?
  content           String                   @db.Text
  author            String
  authorProfilePic  String?
  postUrl           String?
  converted         Boolean                  @default(false)
  convertedTicketId String? // Link to converted ticket
  notificationId    String                   @unique
  createdAt         DateTime                 @default(now())

  // Relations
  notification    Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  convertedTicket Ticket?      @relation(fields: [convertedTicketId], references: [id], onDelete: SetNull)

  @@index([converted])
  @@index([convertedTicketId])
  @@index([createdAt])
}

model SatisfactionRating {
  id        String   @id @default(cuid())
  ticketId  String   @unique
  rating    Int // 1-5
  feedback  String?  @db.Text
  userId    String?
  createdAt DateTime @default(now())

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@index([ticketId])
  @@index([rating])
}

model Template {
  id         String   @id @default(cuid())
  tenantId   String   // Multi-tenant: Company/Organization ID
  name       String
  content    String   @db.Text
  type       String // EMAIL, CANNED_RESPONSE
  category   String? // Category for organizing templates
  variables  Json?
  isActive   Boolean  @default(true)
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([category])
  @@index([isActive])
  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, isActive])
}

model TicketActivity {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String?
  action      String // status_changed, assigned, priority_changed, comment_added, etc.
  description String   @db.Text
  metadata    Json? // Additional data about the activity
  createdAt   DateTime @default(now())

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  userId    String
  ticketId  String?
  changes   Json?
  createdAt DateTime @default(now())

  // Relations
  user   User    @relation(fields: [userId], references: [id])
  ticket Ticket? @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ticketId])
  @@index([createdAt])
}

model SystemSettings {
  id        String   @id @default(cuid())
  tenantId  String   // Multi-tenant: Company/Organization ID
  key       String
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key]) // Setting key unique per tenant
  @@index([tenantId])
}

enum DeliveryChannel {
  IN_APP
  EMAIL
  PUSH
  SMS
  FACEBOOK
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum EmailDigestFrequency {
  REALTIME
  HOURLY
  DAILY
  WEEKLY
}

model NotificationPreference {
  id                String               @id @default(cuid())
  userId            String
  notificationType  String
  inAppEnabled      Boolean              @default(true)
  emailEnabled      Boolean              @default(true)
  pushEnabled       Boolean              @default(false)
  facebookEnabled   Boolean              @default(false)
  emailDigest       EmailDigestFrequency @default(REALTIME)
  quietHoursEnabled Boolean              @default(false)
  quietHoursStart   String?
  quietHoursEnd     String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@index([userId])
}

model NotificationDeliveryLog {
  id             String          @id @default(cuid())
  notificationId String
  channel        DeliveryChannel
  status         DeliveryStatus  @default(PENDING)
  recipient      String
  messageId      String?
  errorMessage   String?         @db.Text
  attempts       Int             @default(1)
  sentAt         DateTime?
  failedAt       DateTime?
  createdAt      DateTime        @default(now())

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@index([channel, status])
  @@index([sentAt])
}

model PushSubscription {
  id         String    @id @default(cuid())
  userId     String
  endpoint   String    @db.Text
  p256dh     String    @db.Text
  auth       String    @db.Text
  userAgent  String?   @db.Text
  deviceType String?
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

model NotificationTemplate {
  id           String          @id @default(cuid())
  type         String          @unique
  channel      DeliveryChannel
  subject      String?
  bodyTemplate String          @db.Text
  htmlTemplate String?         @db.Text
  variables    Json?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([type, channel])
}

model OrderTrackingData {
  id                String    @id @default(cuid())
  tenantId          String    // Multi-tenant: Company/Organization ID
  consigneeContact  String    // Phone number
  orderId           String?   // Order ID (deprecated, kept for migration)
  channelOrderNumber String?  // Channel Order Number (replaces OrderId)
  waybillNumber     String    // Tracking ID (WayBill Number)
  channelOrderDate  DateTime? // Channel Order Date
  deliveredDate     DateTime? // Delivered Date
  pickupWarehouse   String    // Pickup Warehouse (required)
  vendor            String?   // Vendor (optional)
  uploadedBy        String?   // User ID who uploaded the sheet
  uploadedAt        DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([consigneeContact])
  @@index([channelOrderNumber])
  @@index([waybillNumber])
  @@index([orderId])
  @@index([tenantId])
  @@index([tenantId, consigneeContact])
  @@index([tenantId, channelOrderNumber])
  // Unique constraint: only apply when channelOrderNumber is not null
  // For null values, we'll handle uniqueness in application logic
}

enum CallStatus {
  INITIATED
  RINGING
  ANSWERED
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
  CANCELLED
}

model CallLog {
  id            String     @id @default(cuid())
  ticketId      String?    // Associated ticket ID
  agentId       String      // Agent who made the call
  customerName  String      // Customer name
  customerPhone String      // Customer phone number
  agentPhone    String      // Agent phone number
  status        CallStatus  @default(INITIATED)
  duration      Int         @default(0) // Duration in seconds
  attempts      Int         @default(1) // Number of call attempts
  remark        String?     // Additional remarks
  exotelCallId  String?     // Exotel call ID for tracking
  exotelResponse Json?      // Full Exotel API response
  startedAt     DateTime    @default(now())
  endedAt       DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  ticket Ticket? @relation(fields: [ticketId], references: [id], onDelete: SetNull)
  agent  User    @relation("CallLogs", fields: [agentId], references: [id])

  @@index([agentId])
  @@index([ticketId])
  @@index([customerPhone])
  @@index([startedAt])
}
